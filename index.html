<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>2015 NCAA Men's Basketball Tournament</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
    <style>
      html, body, #map {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #FFF;
        overflow: hidden;
        font-family: "Trebuchet MS";
      }
    </style>
    <script src="http://js.arcgis.com/3.13/"></script>
    <script>
      var map, teamLayer, venueLayer, tempLayer;
      var clickCount = 0;
      var finalResults = [];

      require(["esri/map",
               "esri/layers/FeatureLayer",
               "esri/graphic",
               "esri/geometry/Polyline",
               "esri/geometry/Point",
               "esri/symbols/SimpleMarkerSymbol",
               "esri/symbols/SimpleLineSymbol",
               "esri/Color",
               "esri/geometry/geometryEngine",
               "esri/tasks/query",
               "esri/arcgis/utils",
               "esri/urlUtils",
               "dojo/on",
               "dojo/domReady!"], 
              function(Map, FeatureLayer, Graphic, Polyline, Point, SimpleMarkerSymbol, SimpleLineSymbol, Color, geometryEngine, Query, arcgisUtils, urlUtils, on) {
          
          var teamFeatureLayer = new FeatureLayer("http://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/NCAA_Tourney_2015/FeatureServer/1", {
          mode: FeatureLayer.MODE_ONDEMAND,
          outFields: ["*"]
          });
          var venueFeatureLayer = new FeatureLayer("http://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/NCAA_Tourney_2015/FeatureServer/0", {
          mode: FeatureLayer.MODE_ONDEMAND,
          outFields: ["*"]          
          });
          var lineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([0,0,0], 0.5), 2);
          var pointSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 15, lineSymbol, new Color([255,0,0,1]));
          
//          arcgisUtils.createMap('9d2a01add621426eaf97b51375268632', 'map').then(function(response){
//            map = response.map;

          map = new Map("map", {
            basemap: "dark-gray",
            center: [-99, 40],
            zoom: 4
          });
          
          map.addLayers([teamFeatureLayer, venueFeatureLayer]);
          console.log("TeamLayer: ", teamFeatureLayer);
          on(map, "click", function(){
              ++clickCount;
              if(clickCount === 1)
                getDistances(teamFeatureLayer.graphics, venueFeatureLayer.graphics);
          });
          
          var teamCor, venueCor, sr, line, lineJSON;
          
//          function createPointLayerDefinition(fields){
//            var ld = {
//              "geometryType": "esriGeometryPoint",
//              "fields": fields
//            };
//            return ld;
//          }
          
//          function createLineLayerDefinition(){
//            var gt = "esriGeometryPolyline";
//            var school = {
//              "name": "Team",
//              "type": "esriFieldTypeString",
//              "alias": "Team"
//            };
//            var dist = {
//              "name": "Distance",
//              "type": "esriFieldTypeDouble",
//              "alias": "Distance"            
//            };
//            var result = {
//              "name": "Result",
//              "type": "esriFieldTypeInteger",
//              "alias": "Result"            
//            };
//              
//            var ld = {
//              "geometryType": gt,
//              "fields": [school, dist, result]
//            };
//            
//            return ld;
//          }
          
          function getDistances(teamList, venueList){
              console.log("function getDistances() called");
            var teamPt, venuePt;
//            var lineFeatureSet = {};
//            var lineFeatureArray = [];
//            var lineFeat = {};
//            var att = {};
//            var lineSR;
            
            for(i = 0; i < teamList.length; i++){
              teamFeatureLayer.graphics[i].attributes.wins = 0;
//              console.log("team: ", teamList[i]);
              teamPt = teamList[i].geometry;
              teamCor = [teamPt.x, teamPt.y];
              sr = teamPt.spatialReference;
//              lineSR = sr;
              var distance = 0;
                
              teamList[i].attributes.wins = 0;
              teamList[i].potentialTravel = [];
              teamList[i].actualTravel = [];
              teamList[i].distances = [];
              teamList[i].avgDistance = 0;
              teamList[i].wins = 0;
                
              if(teamList[i].attributes.Rd_68_Venue == "UD Arena"){
//                 lineFeat = {};
                 for(j = 0; j < venueList.length; j++){
                     
                  // console.log("Venue List: ", venueList[j]);
                   if(venueList[j].attributes.Name == teamList[i].attributes.Rd_68_Venue){
                    venuePt = venueList[j].geometry;
                    //console.log("venue: ", venueList[j].attributes.Name);
//                       console.log("team: ", teamList[i]);
                    break;
                   }
                 }
                  
                venueCor = [venuePt.x, venuePt.y];
                lineJSON = {
                  paths: [[teamCor, venueCor]],
                  spatialReference: sr
                };
                
                line = new Polyline(lineJSON);
                map.graphics.add(new Graphic(line, lineSymbol));
                distance = geometryEngine.geodesicLength(line, 9093);
                teamList[i].distances.push(distance);
                teamList[i].avgDistance += distance;
//                console.log("line: ", line);
                  
               teamList[i].potentialTravel.push(line);
               teamList[i].actualTravel.push(line);
                  
//               teamFeatureLayer.graphics[i].attributes.Rd_68_Distance = distance;
                  
//               att.Team = teamList[i].attributes.University;
//               att.Distance = distance;
                  
               if(teamList[i].attributes.Rd_68_Result == "W")//{
                  teamList[i].wins += 1;
//                  r = 1;
//               }
//               else{
//                  r = 0;
//               }
              
//               lineFeat.attributes = att;
//               lineFeat.geometry = line;
                
//               lineFeatureArray.push({
//                 "attributes": {
//                   "Team": teamList[i].attributes.University,
//                   "Distance": distance,
//                   "Result": r
//                 },
//                 "geometry": new Polyline(lineJSON)
//               });
                     
            }
            //Round of 64 and 32    
            if(teamList[i].attributes.Rd_64_Result){
                 for(j = 0; j < venueList.length; j++){
                     
                  // console.log("Venue List: ", venueList[j]);
                   if(venueList[j].attributes.Name == teamList[i].attributes.Rd_64_Venue){
                    venuePt = venueList[j].geometry;
                    //console.log("venue: ", venueList[j].attributes.Name);
//                       console.log("team: ", teamList[i]);
                    break;
                   }
                 }
                  
                venueCor = [venuePt.x, venuePt.y];
                lineJSON = {
                  paths: [[teamCor, venueCor]],
                  spatialReference: sr
                };
                
                line = new Polyline(lineJSON);
                map.graphics.add(new Graphic(line, lineSymbol));
                distance = geometryEngine.geodesicLength(line, 9093);
                teamList[i].distances.push(distance);
                teamList[i].avgDistance += distance;
               teamFeatureLayer.graphics[i].attributes.Rd_64_Distance = distance;                
               teamFeatureLayer.graphics[i].attributes.Rd_32_Distance = distance;                  
//                console.log("line: ", line);
                  
               teamList[i].potentialTravel.push(line);
               teamList[i].actualTravel.push(line);
                  
               if(teamList[i].attributes.Rd_64_Result == "W")
                  teamList[i].wins += 1;
               if(teamList[i].attributes.Rd_32_Result == "W")
                  teamList[i].wins += 1;
                     
              }
            //Round of 16 and 8
            if(teamList[i].attributes.Rd_16_Result){
                 for(j = 0; j < venueList.length; j++){
                     
                  // console.log("Venue List: ", venueList[j]);
                   if(venueList[j].attributes.Name == teamList[i].attributes.Rd_16_Venue){
                    venuePt = venueList[j].geometry;
                    //console.log("venue: ", venueList[j].attributes.Name);
//                       console.log("team: ", teamList[i]);
                    break;
                   }
                 }
                  
                venueCor = [venuePt.x, venuePt.y];
                lineJSON = {
                  paths: [[teamCor, venueCor]],
                  spatialReference: sr
                };
                
                line = new Polyline(lineJSON);
                map.graphics.add(new Graphic(line, lineSymbol));
                distance = geometryEngine.geodesicLength(line, 9093);
                teamList[i].distances.push(distance);
                teamList[i].avgDistance += distance;
                
               teamFeatureLayer.graphics[i].attributes.Rd_16_Distance = distance;                
               teamFeatureLayer.graphics[i].attributes.Rd_8_Distance = distance;                
                
//                console.log("line: ", line);
                  
               teamList[i].potentialTravel.push(line);
               teamList[i].actualTravel.push(line);
                  
               if(teamList[i].attributes.Rd_16_Result == "W")
                  teamList[i].wins += 1;
               if(teamList[i].attributes.Rd_8_Result == "W")
                  teamList[i].wins += 1;                
                     
              }
            //Final Four
            if(teamList[i].attributes.Rd_4_Result){
                 for(j = 0; j < venueList.length; j++){
                     
                  // console.log("Venue List: ", venueList[j]);
                   if(venueList[j].attributes.Name == teamList[i].attributes.Rd_4_Venue){
                    venuePt = venueList[j].geometry;
                    //console.log("venue: ", venueList[j].attributes.Name);
//                       console.log("team: ", teamList[i]);
                    break;
                   }
                 }
                  
                venueCor = [venuePt.x, venuePt.y];
                lineJSON = {
                  paths: [[teamCor, venueCor]],
                  spatialReference: sr
                };
                
                line = new Polyline(lineJSON);
                map.graphics.add(new Graphic(line, lineSymbol));
                distance = geometryEngine.geodesicLength(line, 9093);
                teamList[i].distances.push(distance);       
                teamList[i].avgDistance += distance; 
                
                teamFeatureLayer.graphics[i].attributes.Rd_4_Distance = distance;                
                teamFeatureLayer.graphics[i].attributes.Rd_2_Distance = distance;                
                  
//                console.log("line: ", line);
                  
               teamList[i].potentialTravel.push(line);
               teamList[i].actualTravel.push(line);
                  
               if(teamList[i].attributes.Rd_4_Result == "W")
                  teamList[i].wins += 1;
               if(teamList[i].attributes.Rd_2_Result == "W")
                  teamList[i].wins += 1;                
                     
              }
                
              if(teamFeatureLayer.graphics[i].attributes.Rd_68_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;
              if(teamFeatureLayer.graphics[i].attributes.Rd_64_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;                
              if(teamFeatureLayer.graphics[i].attributes.Rd_32_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;             
              if(teamFeatureLayer.graphics[i].attributes.Rd_16_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;                
              if(teamFeatureLayer.graphics[i].attributes.Rd_8_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;
              if(teamFeatureLayer.graphics[i].attributes.Rd_4_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;                
              if(teamFeatureLayer.graphics[i].attributes.Rd_2_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;
              
              var totDist = 0;
              var totDistCount = 0;
              if(teamFeatureLayer.graphics[i].attributes.Rd_68_Distance){
                  totDist += teamFeatureLayer.graphics[i].attributes.Rd_68_Distance;
                  totDistCount++;
              }
              if(teamFeatureLayer.graphics[i].attributes.Rd_64_Distance){
                  totDist += teamFeatureLayer.graphics[i].attributes.Rd_64_Distance;
                  totDistCount++;
              }                
              if(teamFeatureLayer.graphics[i].attributes.Rd_16_Distance){
                  totDist += teamFeatureLayer.graphics[i].attributes.Rd_16_Distance;
                  totDistCount++;
              }              
              if(teamFeatureLayer.graphics[i].attributes.Rd_4_Distance){
                  totDist += teamFeatureLayer.graphics[i].attributes.Rd_4_Distance;
                  totDistCount++;
              }          
                
             teamFeatureLayer.graphics[i].attributes.avgDistance = Math.round(totDist / totDistCount);   
                
             teamList[i].avgDistance = Math.round(teamList[i].avgDistance / teamList[i].distances.length);
            }
//              
//            lineFeatureSet.features = lineFeatureArray;
//            lineFeatureSet.geometryType = "esriGeometryPolyline";
//            lineFeatureSet.spatialReference = lineSR;
              
//            var lineLayDef = createLineLayerDefinition();
//            console.log("line feature array: ", lineFeatureArray);
//            console.log("line feature set: ", lineFeatureSet);
//            console.log("line layer def: ", lineLayDef);
//            var travelLayer = new FeatureLayer({
//              featureSet: lineFeatureSet,
//              layerDefinition: lineLayDef
//            });
            
//            map.addLayer(travelLayer);
//            console.log("Travel layer: ", travelLayer);
//            console.log("team list: ", teamList);
            console.log("team layer: ", teamFeatureLayer);
          }
          
      });
    </script>
  </head>

  <body>
    <div id="map"></div>
  </body>
</html>