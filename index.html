<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>2015 NCAA Men's Basketball Tournament</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
    <style>
      html, body, #map {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #FFF;
        overflow: hidden;
        font-family: "Trebuchet MS";
      }
    </style>
    <script src="http://js.arcgis.com/3.13/"></script>
    <script>
      var map, teamLayer, venueLayer, tempLayer;
      var clickCount = 0;
      var finalResults = [];

      require(["esri/map",
               "esri/layers/FeatureLayer",
               "esri/layers/GraphicsLayer",
               "esri/graphic",
               "esri/renderers/smartMapping",
               "esri/geometry/Polyline",
               "esri/geometry/Point",
               "esri/symbols/SimpleMarkerSymbol",
               "esri/symbols/SimpleLineSymbol",
               "esri/Color",
               "esri/geometry/geometryEngine",
               "esri/tasks/query",
               "esri/arcgis/utils",
               "esri/urlUtils",
               "dojo/on",
               "dojo/domReady!"], 
              function(Map, FeatureLayer, GraphicsLayer, Graphic, smartMapping, Polyline, Point, SimpleMarkerSymbol, SimpleLineSymbol, Color, geometryEngine, Query, arcgisUtils, urlUtils, on) {
          
          var teamFeatureLayer = new FeatureLayer("http://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/NCAA_Tourney_2015/FeatureServer/1", {
          mode: FeatureLayer.MODE_ONDEMAND,
          outFields: ["*"]
          });
          var venueFeatureLayer = new FeatureLayer("http://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/NCAA_Tourney_2015/FeatureServer/0", {
          mode: FeatureLayer.MODE_ONDEMAND,
          outFields: ["*"]          
          });
          var lineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([0,0,0], 0.5), 2);
          var pointSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 15, lineSymbol, new Color([255,0,0,1]));
          
          var travelLayer = new GraphicsLayer({
              dataAttributes: ["Ttam", "distance", "wins"]
          });

          map = new Map("map", {
            basemap: "dark-gray",
            center: [-99, 40],
            zoom: 4
          });
          
          map.addLayers([teamFeatureLayer, venueFeatureLayer]);
          console.log("TeamLayer: ", teamFeatureLayer);
          on(map, "click", function(){
              ++clickCount;
              if(clickCount === 1)
                getDistances(teamFeatureLayer.graphics, venueFeatureLayer.graphics);
          });
          
          var teamCor, venueCor, sr, line, lineJSON;
          
          function getDistances(teamList, venueList){
              console.log("function getDistances() called");
            var teamPt, venuePt;

            for(i = 0; i < teamList.length; i++){
              teamPt = teamList[i].geometry;
              teamCor = [teamPt.x, teamPt.y];
              sr = teamPt.spatialReference;
              var distance = 0;
                
              teamList[i].attributes.wins = 0;
              teamList[i].potentialTravel = [];
              teamList[i].actualTravel = [];
              teamList[i].distances = [];
              teamList[i].avgDistance = 0;
              teamList[i].wins = 0;
                
              if(teamList[i].attributes.Rd_68_Venue == "UD Arena"){

                  lineAtt = {};

                 for(j = 0; j < venueList.length; j++){
                   if(venueList[j].attributes.Name == teamList[i].attributes.Rd_68_Venue){
                    venuePt = venueList[j].geometry;
                    break;
                   }
                 }
                  
                venueCor = [venuePt.x, venuePt.y];
                lineJSON = {
                  paths: [[teamCor, venueCor]],
                  spatialReference: sr
                };
                
                line = new Polyline(lineJSON);

                distance = geometryEngine.geodesicLength(line, 9093);
                teamList[i].distances.push(distance);
                teamList[i].avgDistance += distance;

               teamList[i].potentialTravel.push(line);
               teamList[i].actualTravel.push(line);
                  
                  
                lineAtt.team = teamFeatureLayer.graphics[i].attributes.University;
                lineAtt.distance = distance;
                  
               if(teamList[i].attributes.Rd_68_Result == "W"){
                  teamList[i].wins += 1;
                  lineAtt.wins = 1;
               }
               else{
                  lineAtt.wins = 0;
               }
              
              travelLayer.add(new Graphic(line, lineSymbol, lineAtt));  
                     
            }
            //Round of 64 and 32    
            if(teamList[i].attributes.Rd_64_Result){

                 for(j = 0; j < venueList.length; j++){
                   if(venueList[j].attributes.Name == teamList[i].attributes.Rd_64_Venue){
                    venuePt = venueList[j].geometry;
                    break;
                   }
                 }
                  
                venueCor = [venuePt.x, venuePt.y];
                lineJSON = {
                  paths: [[teamCor, venueCor]],
                  spatialReference: sr
                };
                
                line = new Polyline(lineJSON);

                travelLayer.add(new Graphic(line, lineSymbol));
                distance = geometryEngine.geodesicLength(line, 9093);
                teamList[i].distances.push(distance);
                teamList[i].avgDistance += distance;
               teamFeatureLayer.graphics[i].attributes.Rd_64_Distance = distance;                
               teamFeatureLayer.graphics[i].attributes.Rd_32_Distance = distance;                  
                  
               teamList[i].potentialTravel.push(line);
               teamList[i].actualTravel.push(line);
                  
               if(teamList[i].attributes.Rd_64_Result == "W")
                  teamList[i].wins += 1;
               if(teamList[i].attributes.Rd_32_Result == "W")
                  teamList[i].wins += 1;
                     
              }
            //Round of 16 and 8
            if(teamList[i].attributes.Rd_16_Result){
                
                 for(j = 0; j < venueList.length; j++){
                   if(venueList[j].attributes.Name == teamList[i].attributes.Rd_16_Venue){
                    venuePt = venueList[j].geometry;
                    break;
                   }
                 }
                  
                venueCor = [venuePt.x, venuePt.y];
                lineJSON = {
                  paths: [[teamCor, venueCor]],
                  spatialReference: sr
                };
                
                line = new Polyline(lineJSON);
                travelLayer.add(new Graphic(line, lineSymbol));
                distance = geometryEngine.geodesicLength(line, 9093);
                teamList[i].distances.push(distance);
                teamList[i].avgDistance += distance;
                
               teamFeatureLayer.graphics[i].attributes.Rd_16_Distance = distance;                
               teamFeatureLayer.graphics[i].attributes.Rd_8_Distance = distance;                
                
               teamList[i].potentialTravel.push(line);
               teamList[i].actualTravel.push(line);
                  
               if(teamList[i].attributes.Rd_16_Result == "W")
                  teamList[i].wins += 1;
               if(teamList[i].attributes.Rd_8_Result == "W")
                  teamList[i].wins += 1;                
                     
              }
            //Final Four
            if(teamList[i].attributes.Rd_4_Result){
                
                 for(j = 0; j < venueList.length; j++){
                   if(venueList[j].attributes.Name == teamList[i].attributes.Rd_4_Venue){
                    venuePt = venueList[j].geometry;
                    break;
                   }
                 }
                  
                venueCor = [venuePt.x, venuePt.y];
                lineJSON = {
                  paths: [[teamCor, venueCor]],
                  spatialReference: sr
                };
                
                line = new Polyline(lineJSON);
                travelLayer.add(new Graphic(line, lineSymbol));
                distance = geometryEngine.geodesicLength(line, 9093);
                teamList[i].distances.push(distance);       
                teamList[i].avgDistance += distance; 
                
                teamFeatureLayer.graphics[i].attributes.Rd_4_Distance = distance;                
                teamFeatureLayer.graphics[i].attributes.Rd_2_Distance = distance;                
                  
               teamList[i].potentialTravel.push(line);
               teamList[i].actualTravel.push(line);
                  
               if(teamList[i].attributes.Rd_4_Result == "W")
                  teamList[i].wins += 1;
               if(teamList[i].attributes.Rd_2_Result == "W")
                  teamList[i].wins += 1;                
                     
              }
                
              if(teamFeatureLayer.graphics[i].attributes.Rd_68_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;
              if(teamFeatureLayer.graphics[i].attributes.Rd_64_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;                
              if(teamFeatureLayer.graphics[i].attributes.Rd_32_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;             
              if(teamFeatureLayer.graphics[i].attributes.Rd_16_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;                
              if(teamFeatureLayer.graphics[i].attributes.Rd_8_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;
              if(teamFeatureLayer.graphics[i].attributes.Rd_4_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;                
              if(teamFeatureLayer.graphics[i].attributes.Rd_2_Result == "W")
                  teamFeatureLayer.graphics[i].attributes.wins++;
              
              var totDist = 0;
              var totDistCount = 0;
              if(teamFeatureLayer.graphics[i].attributes.Rd_68_Distance){
                  totDist += teamFeatureLayer.graphics[i].attributes.Rd_68_Distance;
                  totDistCount++;
              }
              if(teamFeatureLayer.graphics[i].attributes.Rd_64_Distance){
                  totDist += teamFeatureLayer.graphics[i].attributes.Rd_64_Distance;
                  totDistCount++;
              }                
              if(teamFeatureLayer.graphics[i].attributes.Rd_16_Distance){
                  totDist += teamFeatureLayer.graphics[i].attributes.Rd_16_Distance;
                  totDistCount++;
              }              
              if(teamFeatureLayer.graphics[i].attributes.Rd_4_Distance){
                  totDist += teamFeatureLayer.graphics[i].attributes.Rd_4_Distance;
                  totDistCount++;
              }          
                
             teamFeatureLayer.graphics[i].attributes.avgDistance = Math.round(totDist / totDistCount);   
                
             teamList[i].avgDistance = Math.round(teamList[i].avgDistance / teamList[i].distances.length);
            }
              
              map.addLayer(travelLayer);
              console.log("team results layer: ", travelLayer);

            console.log("team layer: ", teamFeatureLayer);
//              displayData();
          }
          
          function displayData(){
              console.log("displayData called.");

          }
          
      });
    </script>
  </head>

  <body>
    <div id="map"></div>
  </body>
</html>